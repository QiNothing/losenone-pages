# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Build and deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [14.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      # Checkout.
      - name: Checkout
        uses: actions/checkout@v2

      # Setup environment.
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      # Build.
      - name: Install dependencies
      - run: yarn install

      # Build.
      - name: Build
      - run: yarn pages:build

      # Package.
      - name: Package
        run: cd ./pages/.vuepress/dist/ && tar -czvf dist.tar.gz *

      # Deploy.
      - name: Deploy
        uses: mdallasanta/ssh-scp-deploy@v1.0.4
        with:
          local: "./dist.tar.gz"
          remote: "/data/wwwroot/www.losenone.cn"
          host: ${{secrets.PROD_HOST}}
          port: ${{secrets.PROD_PORT}}
          user: ${{secrets.PROD_USER}}
          key: ${{secrets.PROD_KEY}}
          pre_upload: cd /data/wwwroot/www.losenone.cn && rm -rf *
          post_upload: cd /data/wwwroot/www.losenone.cn && tar -xzvf dist.tar.gz && rm -f dist.tar.gz
          ssh_options: -o StrictHostKeyChecking=no
          scp_options: -v -r
